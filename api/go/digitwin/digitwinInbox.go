// Package digitwin with types and interfaces for using this service with agent 'digitwin'
// DO NOT EDIT. This file is auto generated by tdd2api. Any changes will be overwritten.
// Generated 04 Sep 24 19:21 PDT.
package digitwin

import "errors"
import "github.com/hiveot/hub/lib/utils"
import "github.com/hiveot/hub/lib/hubclient"

// InboxAgentID is the connection ID of the agent managing the Thing.
const InboxAgentID = "digitwin"

// InboxServiceID is the internal thingID of the device/service as used by agents.
// Agents use this to publish events and subscribe to actions
const InboxServiceID = "inbox"

// InboxDThingID is the Digitwin thingID as used by agents. Digitwin adds the dtw:{agent} prefix to the serviceID
// Consumers use this to publish actions and subscribe to events
const InboxDThingID = "dtw:digitwin:inbox"

//--- Schema definitions of Thing 'dtw:digitwin:inbox' ---

// InboxRecord defines a Inbox Record data schema of the digitwin agent.
//
// Record of action request and delivery progress
type InboxRecord struct {

	// Delivered with Delivered Timestamp
	//
	// DateTime in RFC3339milli the action was delivered to the device agent
	Delivered string `json:"delivered,omitempty"`

	// Error with
	//
	// Error if the request could not be completed
	Error string `json:"error,omitempty"`

	// Input with Action Input
	//
	// Action input parameters
	Input any `json:"input,omitempty"`

	// Key with
	//
	// Action key to invoke
	Key string `json:"key,omitempty"`

	// MessageID with
	//
	// Message ID linking requests and delivery updates
	MessageID string `json:"messageID,omitempty"`

	// MessageType with
	//
	// Message action types
	MessageType string `json:"messageType,omitempty"`

	// Progress with
	//
	// Delivery progress
	Progress string `json:"progress,omitempty"`

	// Received with Received Timestamp
	//
	// DateTime in RFC3339milli the action was received by the inbox
	Received string `json:"received,omitempty"`

	// SenderID with
	//
	// Connection ID of the sender. Used to send delivery updates.
	SenderID string `json:"senderID,omitempty"`

	// ThingID with
	//
	// Digitwin Thing ID the action is directed at
	ThingID string `json:"thingID,omitempty"`

	// Timestamp with Timestamp of creation
	//
	// Timestamp in milliseconds since epoch this record was created
	Timestamp int `json:"timestamp,omitempty"`

	// Updated with Updated Timestamp
	//
	// DateTime in RFC3339milli the delivery status was last updated
	Updated string `json:"updated,omitempty"`
}

//--- Argument and Response struct for action of Thing 'dtw:digitwin:inbox' ---

const InboxReadLatestMethod = "readLatest"

// InboxReadLatestArgs defines the arguments of the readLatest function
// Read Latest - Read the latest Thing action record from the inbox
type InboxReadLatestArgs struct {

	// Key with Value Key
	//
	// The action key to read
	Key string `json:"key,omitempty"`

	// ThingID with Thing ID
	//
	// ID of the Thing to read
	ThingID string `json:"thingID,omitempty"`
}

// InboxReadLatestResp defines the response of the readLatest function
// Read Latest - Read the latest Thing action record from the inbox
//
// Action records
type InboxReadLatestResp InboxRecord

// InboxReadLatest client method - Read Latest.
// Read the latest Thing action record from the inbox
func InboxReadLatest(hc hubclient.IHubClient, key string, thingID string) (inboxRecord InboxRecord, err error) {
	var args = InboxReadLatestArgs{key, thingID}
	err = hc.Rpc(InboxDThingID, InboxReadLatestMethod, &args, &inboxRecord)
	return
}

// IInboxService defines the interface of the 'Inbox' service
//
// This defines a method for each of the actions in the TD.
type IInboxService interface {

	// ReadLatest Read Latest
	// Read the latest Thing action record from the inbox
	// This returns a action records
	ReadLatest(senderID string, args InboxReadLatestArgs) (inboxRecord InboxRecord, err error)
}

// NewInboxHandler returns a server handler for Thing 'dtw:digitwin:inbox' actions.
//
// This unmarshalls the request payload into an args struct and passes it to the service
// that implements the corresponding interface method.
//
// This returns the marshalled response data or an error.
func NewInboxHandler(svc IInboxService) func(*hubclient.ThingMessage) hubclient.DeliveryStatus {
	return func(msg *hubclient.ThingMessage) (stat hubclient.DeliveryStatus) {
		var err error
		var resp interface{}
		var senderID = msg.SenderID
		switch msg.Key {
		case "readLatest":
			args := InboxReadLatestArgs{}
			err = utils.DecodeAsObject(msg.Data, &args)
			if err == nil {
				resp, err = svc.ReadLatest(senderID, args)
			} else {
				err = errors.New("bad function argument: " + err.Error())
			}
			break
		default:
			err = errors.New("Unknown Method '" + msg.Key + "' of service '" + msg.ThingID + "'")
			stat.Failed(msg, err)
		}
		stat.Completed(msg, resp, err)
		return stat
	}
}

// InboxTD contains the raw TD of this service for publication to the Hub
const InboxTD = `{"@context":["https://www.w3.org/2022/wot/td/v1.1",{"ht":"https://www.hiveot.net/vocab/v0.1"}],"@type":"Service","created":"2024-05-03T17:00:00.000Z","description":"HiveOT digital twin inbox action storage","id":"inbox","modified":"2024-05-03T17:00:00.000Z","support":"https://www.github.com/hiveot/hub","title":"DigiTwin Inbox","schemaDefinitions":{"inboxRecord":{"title":"Inbox Record","description":"Record of action request and delivery progress","readOnly":false,"type":"object","properties":{"delivered":{"title":"Delivered Timestamp","description":"DateTime in RFC3339milli the action was delivered to the device agent","readOnly":false,"type":"string"},"error":{"description":"Error if the request could not be completed","readOnly":false,"type":"string"},"input":{"title":"Action Input","description":"Action input parameters","readOnly":false},"key":{"description":"Action key to invoke","readOnly":false,"type":"string"},"messageID":{"description":"Message ID linking requests and delivery updates","readOnly":false,"type":"string"},"messageType":{"description":"Message action types","enum":["action","properties"],"readOnly":false,"type":"string"},"progress":{"description":"Delivery progress","enum":["queued","received","applied","completed","failed"],"readOnly":false,"type":"string"},"received":{"title":"Received Timestamp","description":"DateTime in RFC3339milli the action was received by the inbox","readOnly":false,"type":"string"},"senderID":{"description":"Connection ID of the sender. Used to send delivery updates.","readOnly":false,"type":"string"},"thingID":{"description":"Digitwin Thing ID the action is directed at","readOnly":false,"type":"string"},"timestamp":{"title":"Timestamp of creation","description":"Timestamp in milliseconds since epoch this record was created","readOnly":false,"type":"integer"},"updated":{"title":"Updated Timestamp","description":"DateTime in RFC3339milli the delivery status was last updated","readOnly":false,"type":"string"}}}},"actions":{"readLatest":{"@type":"ht:function","title":"Read Latest","description":"Read the latest Thing action record from the inbox","input":{"readOnly":false,"type":"object","properties":{"key":{"title":"Value Name","description":"The action key to read","readOnly":false,"type":"string"},"thingID":{"title":"Thing ID","description":"ID of the Thing to read","readOnly":false,"type":"string"}},"required":["thingID","key"]},"output":{"title":"Inbox Record","description":"Action records","readOnly":false,"type":"object","$ref":"inboxRecord"},"safe":true,"idempotent":true}},"security":["bearer"],"securityDefinitions":{"bearer":{"description":"HTTP protocol authentication","scheme":"bearer","name":"authentication","alg":"es256","format":"jwt","in":"header"}}}`
