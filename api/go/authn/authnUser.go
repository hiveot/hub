// Package authn with types and interfaces for using this service with agent 'authn'
// DO NOT EDIT. This file is auto generated by tdd2api. Any changes will be overwritten.
// Generated 14 Jul 24 20:51 PDT.
package authn

import "errors"
import "github.com/hiveot/hub/lib/things"
import "github.com/hiveot/hub/lib/hubclient"

// UserAgentID is the connection ID of the agent managing the Thing.
const UserAgentID = "authn"

// UserServiceID is the internal thingID of the device/service as used by agents.
// Agents use this to publish events and subscribe to actions
const UserServiceID = "user"

// UserDThingID is the Digitwin thingID as used by agents. Digitwin adds the dtw:{agent} prefix to the serviceID
// Consumers use this to publish actions and subscribe to events
const UserDThingID = "dtw:authn:user"

//--- Schema definitions of Thing 'dtw:authn:user' ---

// ClientProfile defines a Client Profile data schema of the authn agent.
//
// This contains client information of device agents, services and consumers
type ClientProfile struct {

	// ClientID with Client ID
	ClientID string `json:"clientID,omitempty"`

	// ClientType with Client Type
	ClientType ClientType `json:"clientType,omitempty"`

	// Disabled with Disabled
	//
	// This client account has been disabled
	Disabled bool `json:"disabled,omitempty"`

	// DisplayName with Display Name
	DisplayName string `json:"displayName,omitempty"`

	// PubKey with Public Key
	PubKey string `json:"pubKey,omitempty"`

	// Updated with Updated timestamp in msec since epoch
	Updated int64 `json:"updated,omitempty"`
}

// ClientType enumerator
//
// identifies the client's category
type ClientType string

const (

	// ClientTypeAgent for Agent
	//
	// Agents represent one or more devices
	ClientTypeAgent = "agent"

	// ClientTypeService for Service
	//
	// Service enrich information
	ClientTypeService = "service"

	// ClientTypeConsumer for Consumer
	//
	// Consumers are end-users of information
	ClientTypeConsumer = "consumer"
)

// ClientRole enumerator
type ClientRole string

const (

	// ClientRoleNone for No role
	//
	// No role means that the user has no permissions.
	// It can not do anything until the role is upgraded to viewer or better
	// Read permissions: none
	// Write permissions: none
	ClientRoleNone = "none"

	// ClientRoleAdmin for Administrator role
	//
	// Administrators can publish and subscribe to any sources and invoke all services
	// Read permissions: subEvents, subActions
	// Write permissions: pubEvents, pubActions, pubConfig
	ClientRoleAdmin = "admin"

	// ClientRoleAgent for Device agent role
	//
	// Device agents can publish thing events and subscribe to device actions
	// Read permissions: subActions
	// Write permissions: pubTDs, pubEvents
	ClientRoleAgent = "agent"

	// ClientRoleManager for Manager role
	//
	// Managers can subscribe to Thing TD, events, publish actions and update configuration
	// Read permissions: subEvents
	// Write permissions: pubActions, pubConfig
	ClientRoleManager = "manager"

	// ClientRoleOperator for Operator role
	//
	// Operators can subscribe to events and publish actions
	// Read permissions: subEvents
	// Write permissions: pubActions
	ClientRoleOperator = "operator"

	// ClientRoleService for Service role
	//
	// Services act as an admin user and a device
	// Read permissions: subEvents, subActions, subConfig
	// Write permissions: pubEvents, pubActions, pubConfig
	ClientRoleService = "service"

	// ClientRoleViewer for Viewer role
	//
	// Viewers can read TDs and subscribe to Thing Events
	// Read permissions: subEvents
	// Write permissions: none
	ClientRoleViewer = "viewer"
)

//--- Argument and Response struct for action of Thing 'dtw:authn:user' ---

const UserGetProfileMethod = "getProfile"

const UserLoginMethod = "login"

// UserLoginArgs defines the arguments of the login function
// Login - Login with password
type UserLoginArgs struct {

	// ClientID with Login ID
	ClientID string `json:"clientID,omitempty"`

	// Password with Password
	Password string `json:"password,omitempty"`
}

// UserLoginResp defines the response of the login function
// Login - Login with password
type UserLoginResp struct {

	// SessionID with SessionID
	SessionID string `json:"sessionID,omitempty"`

	// Token with Token
	Token string `json:"token,omitempty"`
}

const UserRefreshTokenMethod = "refreshToken"

// UserRefreshTokenArgs defines the arguments of the refreshToken function
// Request a new auth token for the current client -
type UserRefreshTokenArgs struct {

	// ClientID with ClientID
	ClientID string `json:"clientID,omitempty"`

	// OldToken with Old Token
	OldToken string `json:"oldToken,omitempty"`
}

const UserUpdateNameMethod = "updateName"

const UserUpdatePasswordMethod = "updatePassword"

const UserUpdatePubKeyMethod = "updatePubKey"

const UserValidateTokenMethod = "validateToken"

// UserValidateTokenResp defines the response of the validateToken function
// Validate Token - Check if the given token is still valid
type UserValidateTokenResp struct {

	// ClientID with Client ID
	ClientID string `json:"clientID,omitempty"`

	// Error with Validation error
	Error string `json:"error,omitempty"`

	// SessionID with Session ID
	SessionID string `json:"sessionID,omitempty"`
}

// UserGetProfile client method - Get Client Profile.
func UserGetProfile(hc hubclient.IHubClient) (resp ClientProfile, err error) {

	err = hc.Rpc(UserDThingID, UserGetProfileMethod, nil, &resp)
	return
}

// UserLogin client method - Login.
// Login with password
func UserLogin(hc hubclient.IHubClient, clientID string, password string) (resp UserLoginResp, err error) {
	var args = UserLoginArgs{clientID, password}
	err = hc.Rpc(UserDThingID, UserLoginMethod, &args, &resp)
	return
}

// UserRefreshToken client method - Request a new auth token for the current client.
func UserRefreshToken(hc hubclient.IHubClient, clientID string, oldToken string) (token string, err error) {
	var args = UserRefreshTokenArgs{clientID, oldToken}
	err = hc.Rpc(UserDThingID, UserRefreshTokenMethod, &args, &token)
	return
}

// UserUpdateName client method - Request changing the display name of the current client.
func UserUpdateName(hc hubclient.IHubClient, newName string) (err error) {

	err = hc.Rpc(UserDThingID, UserUpdateNameMethod, &newName, nil)
	return
}

// UserUpdatePassword client method - Update Password.
// Request changing the password of the current client
func UserUpdatePassword(hc hubclient.IHubClient, password string) (err error) {

	err = hc.Rpc(UserDThingID, UserUpdatePasswordMethod, &password, nil)
	return
}

// UserUpdatePubKey client method - Update Public Key.
// Request changing the public key on file of the current client.
func UserUpdatePubKey(hc hubclient.IHubClient, publicKeyPEM string) (err error) {

	err = hc.Rpc(UserDThingID, UserUpdatePubKeyMethod, &publicKeyPEM, nil)
	return
}

// UserValidateToken client method - Validate Token.
// Check if the given token is still valid
func UserValidateToken(hc hubclient.IHubClient, token string) (resp UserValidateTokenResp, err error) {

	err = hc.Rpc(UserDThingID, UserValidateTokenMethod, &token, &resp)
	return
}

// IUserService defines the interface of the 'User' service
//
// This defines a method for each of the actions in the TD.
type IUserService interface {

	// GetProfile Get Client Profile
	GetProfile(senderID string) (resp ClientProfile, err error)

	// Login Login
	// Login with password
	Login(senderID string, args UserLoginArgs) (resp UserLoginResp, err error)

	// RefreshToken Request a new auth token for the current client
	RefreshToken(senderID string, args UserRefreshTokenArgs) (token string, err error)

	// UpdateName Request changing the display name of the current client
	UpdateName(senderID string, newName string) error

	// UpdatePassword Update Password
	// Request changing the password of the current client
	UpdatePassword(senderID string, password string) error

	// UpdatePubKey Update Public Key
	// Request changing the public key on file of the current client.
	UpdatePubKey(senderID string, publicKeyPEM string) error

	// ValidateToken Validate Token
	// Check if the given token is still valid
	ValidateToken(senderID string, token string) (resp UserValidateTokenResp, err error)
}

// NewUserHandler returns a server handler for Thing 'dtw:authn:user' actions.
//
// This unmarshalls the request payload into an args struct and passes it to the service
// that implements the corresponding interface method.
//
// This returns the marshalled response data or an error.
func NewUserHandler(svc IUserService) func(*things.ThingMessage) hubclient.DeliveryStatus {
	return func(msg *things.ThingMessage) (stat hubclient.DeliveryStatus) {
		var err error
		var resp interface{}
		var senderID = msg.SenderID
		switch msg.Key {
		case "login":
			args := UserLoginArgs{}
			err = msg.Decode(&args)
			if err == nil {
				resp, err = svc.Login(senderID, args)
			} else {
				err = errors.New("bad function argument: " + err.Error())
			}
			break
		case "refreshToken":
			args := UserRefreshTokenArgs{}
			err = msg.Decode(&args)
			if err == nil {
				resp, err = svc.RefreshToken(senderID, args)
			} else {
				err = errors.New("bad function argument: " + err.Error())
			}
			break
		case "updateName":
			var args string
			err = msg.Decode(&args)
			if err == nil {
				err = svc.UpdateName(senderID, args)
			} else {
				err = errors.New("bad function argument: " + err.Error())
			}
			break
		case "updatePassword":
			var args string
			err = msg.Decode(&args)
			if err == nil {
				err = svc.UpdatePassword(senderID, args)
			} else {
				err = errors.New("bad function argument: " + err.Error())
			}
			break
		case "updatePubKey":
			var args string
			err = msg.Decode(&args)
			if err == nil {
				err = svc.UpdatePubKey(senderID, args)
			} else {
				err = errors.New("bad function argument: " + err.Error())
			}
			break
		case "validateToken":
			var args string
			err = msg.Decode(&args)
			if err == nil {
				resp, err = svc.ValidateToken(senderID, args)
			} else {
				err = errors.New("bad function argument: " + err.Error())
			}
			break
		case "getProfile":
			if err == nil {
				resp, err = svc.GetProfile(senderID)
			} else {
				err = errors.New("bad function argument: " + err.Error())
			}
			break
		default:
			err = errors.New("Unknown Method '" + msg.Key + "' of service '" + msg.ThingID + "'")
			stat.DeliveryFailed(msg, err)
		}
		stat.Completed(msg, resp, err)
		return stat
	}
}
