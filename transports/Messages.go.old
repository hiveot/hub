// Package transports with the 3 flow messages: requests, response and  notifications
package transports

import (
	"github.com/hiveot/hub/transports/tputils"
	"github.com/hiveot/hub/wot"
	"github.com/teris-io/shortid"
	"time"
)

// This defines the standardized message envelopes used by hiveot and its
// transport protocols. Other protocol bindings map their format to this format.

// constants that identify a payload as a request,response or notification
// intended for use in hiveot protocol extensions.
const (
	MessageTypeNotification = "notification"
	MessageTypeRequest      = "request"
	MessageTypeResponse     = "response"
)

// request status
// this aligns with action status values from WoT spec
const (
	// StatusPending - the request has not yet been delivered
	StatusPending = "pending"
	// StatusRunning - the request is being processed
	StatusRunning = "running"
	// StatusCompleted - the request processing was completed
	StatusCompleted = "completed"
	// StatusFailed - the request processing or delivery failed
	StatusFailed = "failed"
)

// RequestMessage for sending a request for an operation on a Thing or service.
// Agents/Things  MUST send a response when a request is received and a correlationID
// is included.
//
// The following operations are considered to be requests:
//
//   - invokeaction  [WoT]
//   - subscribe, unsubscribe [WoT]    (handled by protocol bindings)
//   - observe, unobserve [WoT]        (handled by protocol bindings)
//   - readproperty, readallproperties [WoT]
//   - queryaction, queryallactions [WoT]
//   - readevent, readallevents  (of a Thing)  [HiveOT extension]
//   - readtd, readalltds  (of a directory or thing) [HiveOT extension]
type RequestMessage struct {

	// CorrelationID of the message. Uniquely identifies the request and must be included
	// in the response.
	// Notifications can include this to correlate with the subscription.
	// Message streams can include this to correlate with the original request.
	// This is optional. If omitted, no response will be received.
	CorrelationID string `json:"correlationID,omitempty"`

	// Created holds the timestamp the request was created using RFC3339milli
	// This MUST be set by the protocol server if not provided.
	Created string `json:"created"`

	// Input for the request as described in the TD affordance dataschema.
	// If the operation is one of the Thing level operations, the input is specified
	// by the operation's dataschema. WoT doesn't have this yet so hiveot will
	// define the missing bits if any.
	Input any `json:"input,omitempty"` // native

	// MessageID unique ID of the message. Intended to detect duplicates.
	// Generated by the protocol binding.
	MessageID string `json:"messageID"`

	// MessageType identifies this message payload as a request
	// This is set to "request"
	MessageType string `json:"type"`

	// Name of the event, action or property affordance the request is for.
	// This field is optional and only required for specific operations.
	Name string `json:"name,omitempty"`

	// The operation for this message as defined in TD-1.1 or the hiveot extensions (HTOp...)
	// This identifies the request and is a required field
	Operation string `json:"operation"`

	// SenderID is the account ID of the client sending the request.
	// The protocol server MUST set this to the authenticated client.
	// Intended for services that link requests to the client, such as the state storage service.
	SenderID string `json:"senderID,omitempty"`

	// ThingID of the thing this request is for.
	// For messages from consumers this is the digitwin dThingID
	// For messages to agents this is the agent ThingID
	// This field is required.
	ThingID string `json:"thingID"`
}

// CreateResponse is a helper to easily create a response from a request with the
// status set to 'completed' or failed if err is not nil.
// If err is set then the status is set to failed.
func (req *RequestMessage) CreateResponse(output any, err error) (resp *ResponseMessage) {
	resp = NewResponseMessage(
		req.Operation, req.ThingID, req.Name, output, nil, req.CorrelationID)
	resp.MessageID = shortid.MustGenerate()
	if err != nil {
		resp.Status = StatusFailed
		resp.Error = err.Error()
	}
	return resp
}

// ToString is a helper to easily convert the request input to a string
// maxlen is the maximum string length or 0 for unlimited
func (req *RequestMessage) ToString(maxlen int) string {
	return tputils.DecodeAsString(req.Input, maxlen)
}

// ToObject is a helper to easily convert the request input to an object
func (req *RequestMessage) ToObject(input any) error {
	return tputils.DecodeAsObject(req.Input, &input)
}

// NewRequestMessage creates a new RequestMessage instance.
//
//	operation is the request operation WoTOp... or HTOp...
//	thingID is the thing the value applies to (destination of action or source of event)
//	name is the name of the property, event or action affordance as described in the thing TD
//	input is the request input as defined in the corresponding affordance dataschema.
//	correlationID unique ID of the request or empty when no response is expected
func NewRequestMessage(operation string, thingID, name string, input any, correlationID string) *RequestMessage {
	return &RequestMessage{
		MessageType:   MessageTypeRequest,
		Operation:     operation,
		ThingID:       thingID,
		Name:          name,
		Input:         input,
		CorrelationID: correlationID,
		Created:       time.Now().Format(wot.RFC3339Milli),
		MessageID:     shortid.MustGenerate(),
	}
}

// ResponseMessage serves to notify a single client of the result of a request.
type ResponseMessage struct {

	// CorrelationID of the request this is a response to, if any.
	CorrelationID string `json:"correlationID,omitempty"`

	// Error contains the short error description when status is failed.
	Error string `json:"error"`

	// MessageID unique ID of the message. Intended to detect duplicates.
	// Generated by the protocol binding.
	MessageID string `json:"messageID,omitempty"`

	// MessageType identifies this message payload as a response
	// This is set to the value of MessageTypeResponse
	MessageType string `json:"type"`

	// Name of the action or property affordance this is a response from.
	// This field is optional and intended to help debugging and logging.
	Name string `json:"name,omitempty"`

	// The operation this is a response to. This MUST be the operation provided in the request.
	Operation string `json:"operation"`

	// Output for the request as described in the TD affordance dataschema.
	// If the operation is one of the Thing level operations, the output is specified
	// by the operation's dataschema. WoT doesn't have this yet so hiveot will
	// define the missing bits if any. (see documentation)
	//
	// If status is failed then output optionally contains a detailed error description.
	Output any `json:"output"` // native

	// Timestamp the request was received by the thing agent
	Received string `json:"received"`

	// Status of the request processing: pending, running, completed or failed.
	// (use 'StatusPending', ... constants on top of this file)
	// If status is failed then Error holds the reason and Output possible details
	Status string `json:"status"`

	// Authenticated ID of the agent sending the response, set by the server
	// The protocol server MUST set this to the authenticated client.
	SenderID string `json:"senderID"`

	// ThingID of the thing this is a response from.
	// For responses passed to consumers this is the digitwin dThingID
	// For responses sent by agents this is the agent ThingID
	// This field is optional and intended to help debugging and logging.
	ThingID string `json:"thingID,omitempty"`

	// Timestamp the status was updated in this response
	Updated string `json:"updated"`
}

// ToString is a helper to easily read the response output as a string
func (resp *ResponseMessage) ToString(maxlen int) string {
	return tputils.DecodeAsString(resp.Output, maxlen)
}


// NewResponseMessage creates a new ResponseMessage instance.
//
// This sets status to completed if err is nil or Failed if err is provided.
// If the status is not completed or failed then set it to the appropriate value after creation.
//
//	operation is the request operation WoTOp... or HTOp...
//	thingID is the thing the value applies to (destination of action or source of event)
//	name is the name of the property, event or action affordance as described in the thing TD
//	output is the output data as defined in the corresponding affordance dataschema or nil if not applicable
//	err is the optional error response which will set status to failed
//	correlationID  ID provided by the request
func NewResponseMessage(operation string, thingID, name string, output any, err error, correlationID string) *ResponseMessage {
	resp := &ResponseMessage{
		MessageType:   MessageTypeResponse,
		Operation:     operation,
		ThingID:       thingID,
		Name:          name,
		Output:        output,
		CorrelationID: correlationID,
		Received:      "",
		Status:        StatusCompleted,
		Updated:       time.Now().Format(wot.RFC3339Milli),
		MessageID:     shortid.MustGenerate(),
	}
	if err != nil {
		resp.Error = err.Error()
		//resp.Status = StatusFailed
	}
	return resp
}

// NewNotificationResponse create a subscribe/observe response with status Running
// The correlationID must be set by the server to the subscription correlationID
// If error is set then it is send as part of the response while status is running.
func NewNotificationResponse(operation string, thingID, name string, output any, err error) *ResponseMessage {
	resp := NewResponseMessage(operation, thingID, name, output, err, "")
	resp.Status = StatusRunning
	return resp
}
