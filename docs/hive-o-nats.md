# Hive Of Things on NATS

HiveOT provides a platform for receiving, processing and delivery of IoT data. It is build on top of the NATS JetStream messaging system. It consists of:
1. Messaging Core, which is NATS JetStream.
2. Gateway Bindings which provide data sources.
3. Consumer Bindings for data delivery. This includes user interfaces and bindings to pass data to external processors.
4. Management Services for managing authentication, authorization, NATS configuration and other aspects.

This document describes a design of HiveOT using NATS JetStream.  

## Introduction

At its heart, HiveOT takes data from 'Things' that is provided through so-called 'bindings' and delivers it to interested consumers. It is based on the W3C WoT (Web of Things) standard. The WoT standard defines Things in a TD (Thing Description) document with their properties, events and actions. HiveOT considers all possible information sources as 'Things' and enables interaction with these Things through events and actions. 

Following the WoT standard, HiveOT uses two types of message flows: event flow and action flows. 

Event flow:

```
Thing[event] -> binding -> router -> stream -> consumer
                                        |
                                      store
```

Action flow:

```
Consumer[action] -> router -> stream -> binding -> Thing
                                 |
                               queue
```

Where 'binding' is the device or service that implements the HiveOT support. The binding publishes Thing events and subscribes to actions of the Things it publishes. An IoT device can implement its own binding for direct support of HiveOT. A description of the steps in these flows follows below. 

## Messages

Types of Messages:
* TD documents, constructed by the binding, describe the source Thing with its properties, events and actions. These are sent as events with the event ID '$td'.
* Properties, which is an event with the ID 'properties' containing the thing property values.
* Events, sent by the Thing gateway, are generated by Things that indicate something happened and can contain a payload.
* Actions, are provide by consumers or services to request something to happen on a Thing.

## Event Publishers

Event publishers are bindings that connect to the messaging core and publish events in a WoT standard message format. They apply ETL (extract-transform-load) of the data to ensure WoT compatibility.    

Types of bindings:
* IoT Devices that implement HiveOT support and manage one or more Things such as sensors and actuators
* Services that translate between an IoT protocol and the WoT standard
* Services transform or generate information and publish the resulting events or actions  

Each binding has a unique persistent identifier used in authentication and addressing messages. Messages are accompanied by metadata that includes this binding ID. To address an action message to a Thing, the binding of that Thing must be known.

Each message is published on an address, also called subject in NATS. This address contains the thing's binding, its ID, message type - event - and the event ID. The format is:

> things.{bindingID}.{thingID}.event.{eventID}

Where
* '.' is the NATS separator. (MQTT uses '/')
* 'things' is the standard prefix indicating this is a message about things
* {bindingID} is the authenticated ID of the binding instance that publishes the event. This can be the ID of an IoT device or a service producing events. Multiple instances of teh same binding must have different IDs. 
* {thingID} is the unique ID of the IoT device producing the event. A publisher can publish one or more Things.  
* 'event' is the keyword to indicate the message is an event
* {eventID} identifies the event content of the message as described in the TD document. A few IDs are predefined. Predefined vocabulary types have a $ prefix.
  * $td: event contains the TD document describing a thing
  * $properties: event contains the map of Thing Properties
  * temperature: event contains the temperature value 
  * humidity: ...
  * switch: ...

The TD document describes each event including its vocabulary type (@type field) that contains the standardized type name for this event. For example, the eventID is determined by the underlying technology and can be 'temp' or 'degree'. The the standardized name is in both cases 'temperature'. The TD also describes the unit of the value. 

To simplify management and access control, Things are organized in groups. Group members are either Things, Services or Users. Users have roles such as viewer, operator or manager. More on authorization below. A group is defined as a NATS JetStream stream and subscribes to subjects of the Things that are a member of the group.

For a user to receive event, it subscribes to the group (JetStream stream). If the user is a member of the group then a subscription to the group stream is allowed. A user therefore does not need to subscribe to individual things.


## Action Publisher

Action publishers are services or users that publish an action message. Action messages are requests directed to a Thing with an optional payload, as defined in the Thing's TD document.

An action has the address of the Thing that performs the action. To counter bad actors, the address must contains the authenticated ID of the user sending the action request. 

Message address subject:

> things.{bindingID}.{thingID}.action.{actionID}.{senderID}

Bindings subscribe to the subject "things.{bindingID}.*.action.>". As the action is logged, the ID of the client that send the action is recorded. E.g. an IoT device or service cannot be controlled anonymously. 

Similar to events, the publisher of actions must be identifiable to prevent spam, spoofing and other unauthorized messages. 

As NATS doesn't support identifying the publisher of a message (see also https://github.com/nats-io/nats-server/issues/1173), the subject approach is chosen as this aligns with publishing of events.


## Group Streams

Streams are message stores for delivery of messages to its subscribers. Each stream represents a group with members. A group stream is configured to subscribe to the event subjects of all Things that are a member of the group. 

NATS streams enables group authorization, event storage, lifecycle management, and filtering of group events. 

The authorization service, part of the Hub core, manages the NATS stream configuration based on group definitions. 

To support assigning a Thing as a member of multiple groups, NATS server 2.10 or newer is required. NATS 2.9 or below only support assigning a Thing to a single group stream.


## Authentication

Publishers and subscribers must authenticate in order to receive and publish messages.

Authentication uses NATS authentication mechanism with loginID/password and JWT tokens.

An 'unauthenticated' connection is allowed to access services specific aimed at unauthenticated users, such as authentication and provisioning.

## TBD

How to query the queue? eg get last 24 hours
How to get the latest current? use kv or object store?
How to send action requests? To the group stream or directly to the device? How to support delayed delivery to intermittently connected devices?

